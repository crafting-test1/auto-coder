env:
  - GITHUB_PERSONAL_ACCESS_TOKEN=${secret:github_pat}
  - LINEAR_API_TOKEN=${secret:linear_api_key}
  - LINEAR_WEBHOOK_SECRET=${secret:linear_webhook_secret}
  - SLACK_MCP_XOXB_TOKEN=${secret:slack_token}
endpoints:
  - name: webhook
    http:
      routes:
        - backend:
            target: dev
            port: webhook
          path_prefix: /
      auth_proxy:
        disabled: true
  - name: github-mcp
    type: INTERNAL
    http:
      routes:
        - backend:
            target: mcp-proxy
            port: github
          path_prefix: /
      auth_proxy:
        disabled: true
      path: /mcp
  - name: linear-mcp
    type: INTERNAL
    http:
      routes:
        - backend:
            target: mcp-proxy
            port: linear
          path_prefix: /
      auth_proxy:
        disabled: true
      path: /mcp
  - name: slack-mcp
    type: INTERNAL
    http:
      routes:
        - backend:
            target: slack-mcp
            port: slack
          path_prefix: /
      auth_proxy:
        disabled: true
      path: /mcp
workspaces:
  - name: dev
    ports:
      - name: webhook
        port: 3000
        protocol: HTTP/TCP
    checkouts:
      - path: auto-coder
        repo:
          git: git@github.com:crafting-test1/auto-coder.git
containers:
  - name: github-mcp
    image: ghcr.io/github/github-mcp-server
    args:
      - http
    env:
      - GITHUB_TOOLSETS=repos,issues,pull_requests
    ports:
      - name: github
        port: 8082
        protocol: HTTP/TCP
  - name: mcp-proxy
    image: nginx:alpine
    args:
      - /bin/sh
      - -c
      - |
        printf 'events {} 
        http { 
          server { 
            listen 8082; 
            location /mcp { 
              proxy_set_header Authorization "Bearer $GITHUB_PERSONAL_ACCESS_TOKEN"; 
              proxy_set_header Host github-mcp; 
              proxy_pass http://github-mcp:8082/mcp; 
              proxy_http_version 1.1; 
              proxy_buffering off; 
            } 
          } 
          server { 
            listen 8080; 
            location /mcp { 
              proxy_set_header Authorization "Bearer $LINEAR_API_TOKEN"; 
              proxy_set_header Host mcp.linear.app; 
              proxy_pass https://mcp.linear.app/mcp; 
              proxy_http_version 1.1; 
              proxy_buffering off; 
              proxy_ssl_server_name on;
            } 
          } 
        }' > /etc/nginx/nginx.conf && nginx -g 'daemon off;'
    ports:
      - name: github
        port: 8082
        protocol: HTTP/TCP
      - name: linear
        port: 8080
        protocol: HTTP/TCP
  - name: slack-mcp
    image: ghcr.io/korotovsky/slack-mcp-server:latest
    entrypoint:
      - mcp-server
    args:
      - --transport
      - http
    env:
      - SLACK_MCP_PORT=8081
      - SLACK_MCP_HOST=0.0.0.0
    ports:
      - name: slack
        port: 8081
        protocol: HTTP/TCP
customizations:
  - mcp_server:
      endpoint: github-mcp
  - mcp_server:
      endpoint: slack-mcp
  - mcp_server:
      endpoint: linear-mcp