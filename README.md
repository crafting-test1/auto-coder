# auto-coder

An automated coding assistant with intelligent task monitoring and provider integration.

## Prerequisites

- Node.js 16+ (Node.js 18+ recommended for full ES2022 support)
- pnpm (installed via `npm install -g pnpm` or `corepack enable`)

## Installation

Install dependencies using pnpm:

```bash
pnpm install
```

## Development

Run TypeScript directly without compilation:

```bash
pnpm run dev
```

## Building

Compile TypeScript to JavaScript:

```bash
pnpm run build
```

The compiled output will be in the `dist/` directory.

## Running

Run the compiled JavaScript:

```bash
pnpm start
```

## Available Scripts

- `pnpm run dev` - Run TypeScript directly with tsx (fast development)
- `pnpm run dev:watcher` - Run the watcher subsystem in development mode
- `pnpm run build` - Compile TypeScript to JavaScript
- `pnpm start` - Run the compiled JavaScript
- `pnpm run type-check` - Check types without building

## Project Structure

```
auto-coder/
â”œâ”€â”€ src/              # TypeScript source files
â”‚   â””â”€â”€ index.ts      # Entry point
â”œâ”€â”€ dist/             # Compiled JavaScript (generated by build)
â”œâ”€â”€ node_modules/     # Dependencies
â”œâ”€â”€ package.json      # Project configuration
â”œâ”€â”€ tsconfig.json     # TypeScript configuration
â””â”€â”€ pnpm-lock.yaml    # Dependency lockfile
```

## TypeScript Configuration

- **Target**: ES2022
- **Module**: NodeNext (ESM)
- **Strict mode**: Enabled
- Source maps and declaration files are generated during build

## Watcher Subsystem

The watcher subsystem monitors external task/issue providers (GitHub, GitLab, Jira, Linear, etc.) and normalizes their events into a unified internal event model.

### Features

- **Dual Mode Operation**:
  - **Webhook mode**: Always enabled for real-time event delivery (secure at infrastructure level)
  - **Polling mode**: Optional, enabled when auth token and repositories are configured
  - Both modes can run simultaneously
- **Extensible Provider System**: Easy to add new providers via the `IProvider` interface
- **Event Normalization**: All provider events normalized to a unified `WatcherEvent` format
- **Smart Deduplication**: Two strategies available:
  - **Comment-based**: Posts comments to issues/PRs after processing, checks last comment to avoid duplicates (persistent, works across restarts)
  - **Memory-based**: In-memory TTL cache (fast, but not persistent)
- **Automatic Retry**: Exponential backoff retry for 409 (Conflict) errors from provider APIs
- **Graceful Shutdown**: Clean shutdown sequence with request draining
- **Type-Safe**: Full TypeScript support with comprehensive type definitions
- **Security-Agnostic**: No built-in webhook signature verification - implement security at infrastructure level (reverse proxy, API gateway, etc.)

### Quick Start

1. Copy the example configuration:

```bash
cp config/watcher.example.yaml config/watcher.yaml
```

2. Update `config/watcher.yaml` with your provider credentials:

```yaml
providers:
  github:
    enabled: true

    # Webhook mode is always enabled
    # (Implement security at reverse proxy/API gateway level)

    # Polling mode (optional - provide auth + repositories to enable)
    pollingInterval: 60
    auth:
      type: token
      tokenEnv: GITHUB_TOKEN
    options:
      repositories:
        - owner/repo
      events:
        - issues
        - pull_request
```

**Mode Configuration:**
- **Webhook mode**: Always enabled - receives webhook events from providers
  - Security should be handled at the reverse proxy or API gateway level
  - No signature verification at the application level
- **Polling mode**: Enabled when `auth` + `options.repositories` are provided
  - Actively polls provider APIs for changes
  - Requires authentication token

3. Set environment variables:

```bash
export GITHUB_TOKEN="ghp_your_token_here"
```

4. Run the watcher:

```bash
pnpm run dev:watcher
```

### Standalone Mode

The watcher can run as a standalone service:

```bash
WATCHER_CONFIG=./config/watcher.yaml pnpm run dev:watcher
```

The standalone mode will:
- Load configuration from the specified file
- Register configured providers
- Start webhook server (if needed)
- Start pollers (if needed)
- Log all received events
- Handle graceful shutdown on SIGTERM/SIGINT

### Library Mode

The watcher can also be used as a library:

```typescript
import { Watcher, GitHubProvider } from './watcher/index.js';

const watcher = new Watcher({
  server: { host: 'localhost', port: 3000 },
  providers: {
    github: {
      enabled: true,
      auth: { type: 'token', token: 'your_token' }
    }
  },
  deduplication: {
    enabled: true,
    botUsername: 'auto-coder-bot'
  }
});

watcher.registerProvider('github', new GitHubProvider());

watcher.on('event', (event) => {
  console.log('Received event:', event);
});

await watcher.start();
```

### Configuration

The watcher is configured via YAML files. See `config/watcher.example.yaml` for a complete example.

Key configuration sections:

- **server**: Webhook server settings (host, port, basePath)
- **deduplication**: Event deduplication settings (botUsername, commentTemplate)
- **providers**: Provider-specific configurations
- **logLevel**: Logging verbosity (debug, info, warn, error)

**Error Handling:**
- Automatic exponential retry for 409 (Conflict) errors from provider APIs
- Base delay: 1 second, max delay: 30 seconds, max retries: 5

### Supported Providers

Currently supported providers:

- **GitHub**: Full support for webhooks and polling
  - Events: issues, pull_request, issue_comment
  - Authentication: Personal access token for polling and comment operations
  - Webhook endpoints for real-time event delivery

Additional providers (GitLab, Jira, Linear) can be added by implementing the `IProvider` interface.

### Event Model

All provider events are normalized to the unified `WatcherEvent` format:

```typescript
interface WatcherEvent {
  id: string;              // Unique event ID
  provider: string;        // Provider name (e.g., 'github')
  type: EventType;         // Event type (ISSUE, PULL_REQUEST, etc.)
  action: EventAction;     // Action (CREATED, UPDATED, CLOSED, etc.)
  resource: ResourceInfo;  // Resource details
  actor: Actor;            // User who triggered the event
  metadata: EventMetadata; // Additional metadata
}
```

### Deduplication Strategies

The watcher uses comment-based deduplication to prevent processing the same event multiple times.

#### Comment-Based Deduplication

Posts a comment to the source resource (issue/PR) after processing each event. Before processing, checks if the last comment was posted by the watcher bot.

**Advantages:**
- Persistent across restarts and deployments
- Works in distributed environments (multiple watcher instances)
- Provides visibility into what the watcher has processed
- Self-documenting event processing history

**Configuration:**

```yaml
deduplication:
  enabled: true
  botUsername: auto-coder-bot
  commentTemplate: "ðŸ¤– Event processed by auto-coder watcher at {timestamp}"
```

**Requirements:**
- Provider must support comment operations (GitHub âœ…)
- Bot account needs write access to post comments
- `botUsername` must match the account posting comments

### Webhook Endpoints

Webhook endpoints are automatically registered at:

```
POST /webhook/{provider}
```

For example:
- GitHub: `POST http://localhost:3000/webhook/github`

### Adding Custom Providers

To add a custom provider:

1. Create a new provider class extending `BaseProvider`:

```typescript
import { BaseProvider } from './watcher/providers/BaseProvider.js';

export class CustomProvider extends BaseProvider {
  get metadata(): ProviderMetadata {
    return {
      name: 'custom',
      version: '1.0.0',
    };
  }

  async initialize(config: ProviderConfig): Promise<void> {
    await super.initialize(config);
    // Initialize provider
  }

  async validateWebhook(headers, body, rawBody): Promise<WebhookValidationResult> {
    // Validate required headers and payload structure
    return { valid: true };
  }

  async normalizeWebhook(headers, body): Promise<NormalizedWebhookResult> {
    // Normalize webhook to WatcherEvent[]
  }

  async poll(): Promise<WatcherEvent[]> {
    // Poll provider API
  }
}
```

2. Register the provider:

```typescript
watcher.registerProvider('custom', new CustomProvider());
```

3. Add configuration:

```yaml
providers:
  custom:
    enabled: true
    # Webhook mode is always enabled
    # Polling mode enabled if auth + repositories configured
    auth:  # Optional: enables polling mode (if supported)
      type: token
      tokenEnv: CUSTOM_TOKEN
    # ... provider-specific config
```

### Architecture

```
src/watcher/
â”œâ”€â”€ types/              # Type definitions
â”œâ”€â”€ core/               # Core components (ConfigLoader, Deduplicator, EventEmitter)
â”œâ”€â”€ transport/          # Transport layer (WebhookServer, Poller)
â”œâ”€â”€ providers/          # Provider implementations
â”‚   â”œâ”€â”€ BaseProvider.ts
â”‚   â”œâ”€â”€ ProviderRegistry.ts
â”‚   â””â”€â”€ github/        # GitHub provider
â””â”€â”€ utils/             # Utilities (logger, crypto, errors)
```

For detailed architecture and design decisions, see `spec/watcher.md`.